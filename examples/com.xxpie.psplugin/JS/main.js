(function(){var d="https://int.xxpie.com/";var e="api/ps/task/getShootingTasksWithRetouch";var t="api/ps/task/getDesignTasksByPhotographerId";var n="api/ps/task/getDesignTaskPhotos";var s="api/ps/task/joinShootingTaskRetouchPhotos";var o="api/ps/task/getPhotoDoneDesignTasks";var a="api/ps/task/getDonePhotosByTaskId";var i="api/ps/task/hideShootingTaskPhotoById";var r="api/ps/task/deleteShootingTaskPhotoById";var c="api/ps/mine/getQiNiuUploadToken";var p="api/ps/task/setPhotoRetouchCompleted";var l="api/ps/mine/getPSPluginVersion";var h="api/ps/task/queryRetouchShootingTaskByCode";var u="api/ps/task/batchSetPhotoCompleted";var f="api/console/sys/addSysUserOperationLog";var g=1e3;var m=require("fs");var w=require("http");var P=require("path");var k=require("qiniu");var I=require("lodash");var _=new CSInterface;var v=function(o,e,t){var n=m.createWriteStream(e);var s=w.get(o,function(o){o.pipe(n);n.on("finish",function(){n.close(t)})},function(o){t(o)});s.on("error",function(o){m.unlink(e);return t(o.message)});n.on("error",function(o){m.unlink(e);return t(o.message)})};var x=function(o,e,t){console.info(o,e);axios.post(d+f,{page_name:o,event_name:e,platform:"PSPLUGIN",token:t}).then(function(o){console.log("记录日志成功")}).catch(function(o){console.log(o)})};var S=function(t){var n=document.getElementById("dialog"),e=document.getElementById("icon-no-longer-prompt"),s="我知道了",a="取消",o="提示",i=false;e.src="https://common.xxpie.com/ps:ic_bounced_unselect.png";n.style.display="none";try{if(typeof t!=="object"){throw"参数不是对象"}var r=Object.keys(t),c=false;r.forEach(function(o){if(o==="content"){c=true}});if(!c){throw"content必填"}var l=Array.prototype.slice.apply(n.children[0].children);l.forEach(function(o){if(o.className==="title"){o.innerHTML=t.title||_t3}if(o.className==="content"){o.innerHTML=t.content}if(o.className==="no-longer-prompt"){o.display=t.showNoLongerPrompt?"block":"none";o.onclick=function(o){i=!i;e.src=i?"https://common.xxpie.com/ps:ic_bounced_selected.png":"https://common.xxpie.com/ps:ic_bounced_unselect.png"}}if(o.className==="btn-group"){Array.prototype.slice.apply(o.children).forEach(function(o){if(o.className==="btn-cancel"){t.showCancel=t.showCancel===undefined?true:t.showCancel;if(t.showCancel){o.style.display="inline-block";o.innerHTML=t.cancelText||a}else{o.style.display="none"}o.onclick=function(o){var e=o||window.event;n.style.display="none";if(t.cancel&&typeof t.cancel==="function"){t.cancel(e)}}}if(o.className==="btn-confirm"){o.innerHTML=t.confirmText||s;o.onclick=function(o){var e=o||window.event;n.style.display="none";if(t.ok&&typeof t.ok==="function"){t.ok(e,{isNoLongerPrompt:i})}}}})}});n.style.display="block"}catch(o){console.error("Error: "+o)}};var T=window.localStorage.getItem("token");var y=new Vue({el:"#root",data:{pageSize:g,currentTab:1,tasks:[],designTasks:[],photos:[],opendPhotos:[],currentPhoto:{},searchCode:"",searched:false,designTaskDetail:false,designTaskDetailList:true,isLoading:false,currentPhotoIndex:1,currentTaskIndex:-1,designPhotosCount:0,hasUpdate:false,operation:false,isShowUpdatePsTips:false,selectedPhotoIds:[],selectedCurrentPhotos:[],selectedAllPhotos:[],shootTaskIds:[],currentVersionCode:14,currentVersionName:"3.0.2",versionInfo:{},bigImage:false,morePhotos:false,photosNum:0,isDeletePhoto:false,isHidePhoto:false,bigImageBack:true,workSpaceCount:0,updating:false,downloadPaths:"",uploadFailed:false,isBatchDownloading:false,processed:{isShowAlbums:true,isShowPhotos:false,albums:[],currentAlbum:{},photos:[],currentPhotoIndex:0,currentPhoto:{},isOpenOriginPhoto:false}},computed:{},watch:{},methods:{showTab:function(o){y.currentTab=o;y.isBatchDownloading=false;switch(y.currentTab){case 1:y.loadTasks(1);break;case 2:y.loadDesignTasks(1);break;case 3:y.loadProcessedAlbums();break;case 4:y.isShowUpdatePsTips=false;break;default:break}},loadTasks:function(o){y.isLoading=true;axios.get(d+e,{params:{page_size:g,current_page:o,token:T}}).then(function(o){if(o.status===200){console.info(o.data);y.taskTotalCount=o.data.count;y.tasks=o.data.tasks;y.isLoading=false}}).catch(function(o){console.log("error status: "+o.status);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},checkPhotos:function(o){axios.post(d+s,{token:T,shoot_task_id:y.tasks[o].shoot_task_id}).then(function(o){y.loadTasks(1)}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},search:function(){if(I.isEmpty(y.searchCode)){y.loadTasks(1);return}axios.get(d+h,{params:{code:y.searchCode,token:T}}).then(function(o){if(o.status===200){o.data.cover_photo_url=o.data.cover_thumbnail_url;y.tasks=[o.data]}}).catch(function(o){if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},deletedCode:function(){y.searchCode="";y.loadTasks(1)},loadDesignTasks:function(o){y.isLoading=true;y.designTaskDetail=false;y.designTaskDetailList=true;axios.get(d+t,{params:{pageSize:g,currentPage:o,token:T}}).then(function(o){console.info(o);if(o.status===200){console.info(o.data);y.designTasks=o.data;y.photosNum=y.designTasks;y.isLoading=false}}).catch(function(o){console.log("error status: "+o.status);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},loadTaskPics:function(o,e){y.photos=[];y.designTaskDetail=true;y.designTaskDetailList=false;y.currentTaskIndex=e;y.operation=false;y.selectedPhotoIds=[];y.selectedCurrentPhotos=[];y.isLoading=true;y.photosNum=o.photo_count;y.bigImage=false;y.bigImageBack=true;axios.get(d+n,{params:{designerTaskId:o.designer_task_id,shootTaskId:o.shoot_task_id,pageSize:12,token:T}}).then(function(o){if(o.status===200&&!I.isEmpty(o.data)){I.forEach(o.data.photos,function(o){o.path=""});y.photos=o.data.photos;y.designPhotosCount=y.photos.length;y.currentPhoto=y.photos[0];y.isLoading=false}}).catch(function(o){if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试!")}})},moreTaskPics:function(o,e){y.designTaskDetail=true;y.designTaskDetailList=false;y.currentTaskIndex=e;y.operation=false;y.selectedPhotoIds=[];y.selectedCurrentPhotos=[];y.photosNum=o.photo_count;if(y.designPhotosCount<12){axios.get(d+n,{params:{designerTaskId:o.designer_task_id,shootTaskId:o.shoot_task_id,pageSize:12,token:T}}).then(function(o){if(o.status===200&&!I.isEmpty(o.data)){if(o.data.photos.length==y.designPhotosCount){y.morePhotos=true;return}I.forEach(o.data.photos,function(o){o.path=""});y.photos=o.data.photos;y.designPhotosCount=y.photos.length;y.currentPhoto=y.photos[0]}}).catch(function(o){if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试!")}})}else{if(window.localStorage&&window.localStorage.getItem("is_deal_photos")==="true"){return}S({title:"图片处理提示",content:"插件一次只展示12张图片，请先处理完当前图片再试哦！",showNoLongerPrompt:true,showCancel:true,confirmText:"我知道了",ok:function(o,e){if(e.isNoLongerPrompt&&window.localStorage){window.localStorage.setItem("is_deal_photos",true)}},cancel:function(o,e){return}})}},hideMorePhotoBox:function(){y.morePhotos=false},showBigPhoto:function(o,e){x("main_workspace","showBigPhoto",T);if(y.operation===true){return}else{y.bigImage=true;y.designTaskDetail=false;y.bigImageBack=false;y.currentPhotoIndex=o;y.currentPhoto=e}},nextBigPhoto:function(){if(y.currentPhotoIndex>=y.photos.length-1){y.currentPhotoIndex=0}else{y.currentPhotoIndex++}y.currentPhoto=y.photos[y.currentPhotoIndex]},preBigPhoto:function(){if(y.currentPhotoIndex<=0){y.currentPhotoIndex=y.photos.length-1}else{y.currentPhotoIndex--}y.currentPhoto=y.photos[y.currentPhotoIndex]},returnDesignTasks:function(){y.designTaskDetail=false;y.designTaskDetailList=true},goBack:function(){y.selectedPhotoIds=[];y.selectedCurrentPhotos=[];y.operation=false;y.bigImage=false;y.bigImageBack=true;y.designTaskDetail=true},openInPS:function(e){console.dir(e);if(e.path){console.log("保存到云端");y.postImage(e)}else{var o=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin");if(!m.existsSync(o)){m.mkdirSync(o)}var t=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin","cache");if(!m.existsSync(t)){m.mkdirSync(t)}var n=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin","cache",e.file_name);n=n.split("\\").join("/");v(e.url_origin,n,function(o){console.log("下载完毕:"+n);_.evalScript("openFile('"+n+"');",function(o){if(o=="null"){console.log("打开完毕");e.path=n;y.currentPhoto=e;y.opendPhotos.push(e);return true}})})}},hidePhotoTips:function(t){if(window.localStorage&&window.localStorage.getItem("is_hide_photo_tips")==="true"){y.hidePhoto(t);return}S({title:"隐藏提示",content:'照片隐藏后将放入相册"已隐藏"中，相册中将无法查看该照片，“相册创建者”可以从享像派App或Web后台(<a href=`https://www.xxpie.com`>https://www.xxpie.com</a>)删除或恢复到相册。',showNoLongerPrompt:true,showCancel:true,confirmText:"我知道了",ok:function(o,e){if(e.isNoLongerPrompt&&window.localStorage){window.localStorage.setItem("is_hide_photo_tips",true)}y.hidePhoto(t)},cancel:function(o,e){return}})},hidePhoto:function(e){axios.post(d+i,{token:T,shoot_task_id:e.shoot_task_id,photo_ids:[e.photo_id]}).then(function(o){console.log("隐藏照片成功");_.evalScript("closeFile('"+e.file_name+"')",function(){console.log("关闭文件成功")});y.designPhotosCount=y.designPhotosCount-1;y.opendPhotos.splice(y.opendPhotos.indexOf(e),1);y.photos.splice(y.photos.indexOf(e),1);if(y.currentPhotoIndex==y.photos.length){y.bigImage=false;y.designTaskDetail=true;y.bigImageBack=true;y.operation=false}else{y.currentPhoto=y.photos[y.currentPhotoIndex]||""}if(e.path){m.unlink(e.path,function(){console.log("删除成功")})}}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},showDeletetips:function(t){if(window.localStorage&&window.localStorage.getItem("is_delete_photo")==="true"){y.deletePhoto(t);return}S({title:"删除提示",content:"照片删除后将放入相册“已删除”，相册中将无法查看该照片，“相册创建者”可以从享像派App或Web后台(<a href=`https://www.xxpie.com`>https://www.xxpie.com</a>)清空回收站或恢复到相册。",showNoLongerPrompt:true,showCancel:true,confirmText:"我知道了",ok:function(o,e){y.deletePhoto(t);if(e.isNoLongerPrompt&&window.localStorage){window.localStorage.setItem("is_delete_photo",true)}},cancel:function(o,e){return}})},deletePhoto:function(e){axios.post(d+r,{token:T,shoot_task_id:e.shoot_task_id,photo_ids:[e.photo_id]}).then(function(o){console.log("删除照片成功");_.evalScript("closeFile('"+e.file_name+"')",function(){console.log("关闭文件成功")});y.designPhotosCount=y.designPhotosCount-1;y.opendPhotos.splice(y.opendPhotos.indexOf(e),1);y.photos.splice(y.photos.indexOf(e),1);if(y.currentPhotoIndex==y.photos.length){y.bigImage=false;y.designTaskDetail=true;y.bigImageBack=true;y.operation=false}else{y.currentPhoto=y.photos[y.currentPhotoIndex]||""}if(e.path){m.unlink(e.path,function(){console.log("删除成功")})}}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},setPhotoCompletedTips:function(t){if(window.localStorage&&window.localStorage.getItem("is_completed_photo")==="true"){y.setPhotoCompleted(t);return}S({title:"免修提示",content:"免修意味着该照片可以直接呈现给用户，跳过对该照片的修图处理。",showNoLongerPrompt:true,showCancel:true,confirmText:"我知道了",ok:function(o,e){y.setPhotoCompleted(t);if(e.isNoLongerPrompt&&window.localStorage){window.localStorage.setItem("is_completed_photo",true)}},cancel:function(o,e){return}})},setPhotoCompleted:function(e){axios.post(d+p,{token:T,origin_photo_id:e.photo_id,photo_hash:e.photo_hash,photo_key:e.photo_key}).then(function(o){console.log("跳过照片成功");if(y.currentPhotoIndex==y.photos.length){y.bigImage=false;y.designTaskDetail=true;y.bigImageBack=true;y.operation=false}_.evalScript("closeFile('"+e.file_name+"')",function(){console.log("关闭文件成功")});y.designPhotosCount=y.designPhotosCount-1;y.opendPhotos.splice(y.opendPhotos.indexOf(e),1);y.photos.splice(y.photos.indexOf(e),1);if(y.currentPhotoIndex==y.photos.length){y.bigImage=false;y.designTaskDetail=true;y.bigImageBack=true}else{y.currentPhoto=y.photos[y.currentPhotoIndex]||""}if(e.path){m.unlink(e.path,function(){console.log("删除成功")})}}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}else{alert("请求失败, 请稍后重试")}})},postImage:function(l){var h=l.path+"-v2.jpg";_.evalScript("saveFile('"+h+"','"+l.file_name+"')",function(){axios.get(d+c,{params:{token:T}}).then(function(o){console.log("七牛上传token"+o.data.token);var e=o.data.token;var t=(new Date).getTime();var n="",s=0;if(l.photo_key.indexOf(".jpg")>=0){n=l.photo_key.replace(".jpg",t+".jpg")}else{n=l.photo_key+t+".jpg"}console.log("uploadKey:"+n);var a={fname:l.file_name};var i={useCdnDomain:true};var r=m.statSync(h);if(r.isFile()){s=r.size}var c=new k.form_up.FormUploader(i);c.putFile(e,n,h,a,function(o,e,t){if(!o&&t.statusCode===200){console.log("上传成功"+e.hash+"key: "+e.key);axios.post(d+p,{token:T,origin_photo_id:l.photo_id,photo_hash:e.hash,photo_key:e.key,file_size:s}).then(function(o){console.log("保存成功");_.evalScript("closeFile('"+l.file_name+"')");y.opendPhotos.splice(y.opendPhotos.indexOf(l),1);y.photos.splice(y.photos.indexOf(l),1);if(y.currentPhotoIndex==y.photos.length){y.bigImage=false;y.designTaskDetail=true;y.bigImageBack=true;y.operation=false}else{y.currentPhoto=y.photos[y.currentPhotoIndex]}m.unlink(l.path,function(){console.log("删除成功")});m.unlink(h,function(){console.log("删除成功")})}).catch(function(o){console.log("保存失败。"+o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})}else{console.log("上传失败"+o+t)}})})})},loadProcessedAlbums:function(){y.processed.isShowAlbums=true;y.processed.isShowPhotos=false;y.isLoading=true;axios.get(d+o,{params:{token:T}}).then(function(o){if(o.data.length>0){y.processed.albums=o.data;y.isLoading=false}}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})},loadProcessedAlbumPhotos:function(o){y.processed.photos=[];y.processed.isShowAlbums=false;y.processed.isShowPhotos=true;y.processed.currentAlbum=o||{};console.log("开始加载已处理照片列表...");axios.get(d+a,{params:{token:T,designerTaskId:o.designer_task_id}}).then(function(o){if(o.data.length>0){y.processed.photos=o.data}}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})},showProcessedAlbumLargePhoto:function(o,e){y.processed.isShowPhotos=false;y.processed.currentPhotoIndex=o;y.processed.currentPhoto=e},preProcessedAlbumLargePhoto:function(){console.info(y.processed.currentPhotoIndex);if(y.processed.currentPhotoIndex<=0){return}y.processed.isOpenOriginPhoto=false;y.processed.currentPhotoIndex--;y.processed.currentPhoto=y.processed.photos[y.processed.currentPhotoIndex]},nextProcessedAlbumLargePhoto:function(){console.info(y.processed.currentPhotoIndex);if(y.processed.currentPhotoIndex>=y.processed.photos.length-1){return}y.processed.isOpenOriginPhoto=false;y.processed.currentPhotoIndex++;y.processed.currentPhoto=y.processed.photos[y.processed.currentPhotoIndex]},processAlbumBack:function(){y.processed.isOpenOriginPhoto=false;if(!y.processed.isShowPhotos&&!y.processed.isShowAlbums){y.processed.isShowPhotos=true}else if(!y.processed.isShowAlbums){y.processed.isShowAlbums=true}},postReworkImage:function(l){var h=l.path+"-v2.jpg";_.evalScript("saveFile('"+h+"','"+l.file_name+"')",function(){axios.get(d+c,{params:{token:T}}).then(function(o){console.log("七牛上传token"+o.data.token);var e=o.data.token;var t=(new Date).getTime();var n="",s=0;if(l.photo_key.indexOf(".jpg")>=0){n=l.photo_key.replace(".jpg",t+".jpg")}else{n=l.photo_key+t+".jpg"}console.log("uploadKey:"+n);var a={fname:l.file_name};var i={useCdnDomain:true};var r=m.statSync(h);if(r.isFile()){s=r.size}var c=new k.form_up.FormUploader(i);c.putFile(e,n,h,a,function(o,e,t){if(!o&&t.statusCode===200){console.log("上传成功"+e.hash+"key: "+e.key);axios.post(d+p,{token:T,origin_photo_id:l.photo_id,photo_hash:e.hash,photo_key:e.key,file_size:s}).then(function(o){console.log("保存成功");_.evalScript("closeFile('"+l.file_name+"')");y.opendPhotos.splice(y.opendPhotos.indexOf(l),1);y.processed.currentPhoto.url_thumbnail=o.data.url_thumbnail;y.processed.currentPhoto.url_large=o.data.url_large;y.processed.isOpenOriginPhoto=false;m.unlink(l.path,function(){console.log("删除成功")});m.unlink(h,function(){console.log("删除成功")})}).catch(function(o){console.log("保存失败。"+o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})}else{console.log("上传失败"+o+t)}})})})},processedAlbumReworkOrSaveToCloud:function(){if(y.processed.isOpenOriginPhoto){if(window.localStorage&&window.localStorage.getItem("is_show_covered_photo_tips")==="true"){y.postReworkImage(y.processed.currentPhoto);return}S({title:"保存提示",content:"保存后重修前的图片会被覆盖，H5上展示的图片以此次保存效果为准。",showNoLongerPrompt:true,showCancel:true,confirmText:"我知道了",ok:function(o,e){if(e.isNoLongerPrompt&&window.localStorage){window.localStorage.setItem("is_show_covered_photo_tips",true)}y.postReworkImage(y.processed.currentPhoto)},cancel:function(o){y.processed.isOpenOriginPhoto=false}})}else{var e=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin","cache",y.processed.currentPhoto.file_name);e=e.split("\\").join("/");v(y.processed.currentPhoto.url_origin,e,function(o){console.log("下载完毕:"+e);_.evalScript("openFile('"+e+"');",function(o){if(o=="null"){y.processed.isOpenOriginPhoto=true;y.processed.currentPhoto.path=e;y.processed.currentPhoto.photo_id=y.processed.currentPhoto.photo_id}})})}},checkUpdate:function(){axios.get(d+l).then(function(o){if(o.status==200&&o.data.version_code>y.currentVersionCode){y.hasUpdate=true;y.versionInfo=o.data}else{y.isShowUpdatePsTips=true}}).catch(function(o){if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})},hideUpdatePsTips:function(){y.isShowUpdatePsTips=false},updateNow:function(){y.updating=true;y.hasUpdate=false},aboutUs:function(){_.openURLInDefaultBrowser("http://www.xxpie.com")},logout:function(){window.localStorage.removeItem("token");window.location.replace("./index.html")},getHelp:function(){_.openURLInDefaultBrowser("https://www.xxpie.com/helpPs.html")},returnTaskList:function(){y.loadTasks(1);y.searched=false},batchOperation:function(){if(y.photos.length>0){x("main_workspace","batchOperation",T);y.operation=true}},batchDeletePhoto:function(){console.info(y.selectedPhotoIds);if(y.selectedPhotoIds.length>0){axios.post(d+r,{token:T,photo_ids:y.selectedPhotoIds}).then(function(o){console.log("删除照片成功");x("main_workspace","batchDeletePhoto",T);y.operation=false;y.photos=I.filter(y.photos,function(o){return y.selectedPhotoIds.indexOf(o.photo_id)<0});y.selectedPhotoIds=[];y.designPhotosCount=y.photos.length}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})}else{}},batchHidePhoto:function(){if(y.selectedPhotoIds.length>0){axios.post(d+i,{token:T,photo_ids:y.selectedPhotoIds}).then(function(o){console.log("删除照片成功");x("main_workspace","batchHidePhoto",T);y.operation=false;y.photos=I.filter(y.photos,function(o){return y.selectedPhotoIds.indexOf(o.photo_id)<0});y.selectedPhotoIds=[];y.designPhotosCount=y.photos.length}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})}},batchSetPhotoCompleted:function(){if(y.selectedPhotoIds.length>0){var t=[];I.each(y.selectedPhotoIds,function(o){var e=I.first(y.selectedCurrentPhotos[o]||[])||{};t.push({origin_photo_id:e.photo_id,photo_key:e.photo_key,photo_hash:e.photo_hash,file_size:e.file_size,bucket_name:e.bucket_name})});axios.post(d+u,{token:T,photos:t}).then(function(o){console.log("批量跳过照片成功");x("main_workspace","batchIgnorePhoto",T);y.operation=false;y.photos=I.filter(y.photos,function(o){return y.selectedPhotoIds.indexOf(o.photo_id)<0});y.selectedPhotoIds=[];y.designPhotosCount=y.photos.length}).catch(function(o){console.log(o);if(o.statusCode===403){window.localStorage.removeItem("token");window.localStorage.removeItem("username");window.location.replace("./index.html")}})}},selectOne:function(o){console.info(o);if(o>=0){var e=y.photos[o];if(I.isEmpty(y.selectedCurrentPhotos[e.photo_id])){y.selectedCurrentPhotos[e.photo_id]=[e];y.selectedPhotoIds.push(e.photo_id)}else{y.selectedCurrentPhotos=I.omit(y.selectedCurrentPhotos,[e.photo_id]);y.selectedPhotoIds.splice(y.selectedPhotoIds.indexOf(e.photo_id),1)}}},selecteAll:function(){if(y.selectedPhotoIds.length<y.photos.length){y.selectedCurrentPhotos=I.groupBy(y.photos,"photo_id");y.selectedPhotoIds=I.map(y.photos,"photo_id")}else{y.selectedCurrentPhotos=[];y.selectedPhotoIds=[]}},returnBack:function(){y.operation=false;y.selectedCurrentPhotos=[];y.selectedPhotoIds=[]},closeDialog:function(){y.updating=false},openOnePhoto:function(e){if(y.selectedPhotoIds.length>0){y.isBatchDownloading=true;var o=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin");if(!m.existsSync(o)){m.mkdirSync(o)}var t=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin","cache");if(!m.existsSync(t)){m.mkdirSync(t)}var n=I.first(y.selectedCurrentPhotos[y.selectedPhotoIds[e]]||[])||{};var s=P.join(_.getSystemPath(SystemPath.USER_DATA),"com.xxpie.psplugin","cache",n.file_name);s=s.split("\\").join("/");v(n.url_origin,s,function(o){console.log("下载完毕:"+s);n.path=s;y.opendPhotos.push(n);y.downloadPaths+=s+",";e++;if(e<y.selectedPhotoIds.length){y.openOnePhoto(e)}else{_.evalScript("openFiles('"+y.downloadPaths+"');",function(o){if(o=="null"){console.log("打开完毕");y.isBatchDownloading=false;y.bigImage=true;y.designTaskDetail=false;y.bigImageBack=false;y.currentPhotoIndex=I.findIndex(y.photos,{photo_id:y.selectedPhotoIds[0]});y.currentPhoto=y.photos[y.currentPhotoIndex]}})}})}},batchDownloadPhotos:function(){var o=0;y.downloadPaths="";y.openOnePhoto(o)}}});y.loadTasks(1);var C=function(e){y.currentPhoto=I.find(y.opendPhotos,function(o){return e.search(o.path)>-1})||""};var b=function(o){var e=new DOMParser;var t=e.parseFromString(o.data,"text/xml");var n=t.getElementsByTagName("name")[0].textContent;var s=t.getElementsByTagName("url")[0].textContent;C(s)};var D=function(o){_.evalScript("app.documents.length",function(o){console.log(o+(o==="0"));if(o==="0"){console.log("没有打开的文件了");y.currentPhoto=y.photos[0]}})};var L=function(o){};var A=new CSEvent;A.type="com.adobe.PhotoshopPersistent";A.scope="APPLICATION";A.extensionId=_.getExtensionID();_.dispatchEvent(A);_.addEventListener("documentAfterActivate",b);_.addEventListener("documentAfterDeactivate",D);_.addEventListener("applicationBeforeQuit",L);window.onbeforeunload=function(){_.removeEventListener("documentAfterActivate",b);_.removeEventListener("documentAfterDeactivate",D);_.removeEventListener("applicationBeforeQuit",L)}})();